services:
  app:
    image: ghcr.io/harmonytics/django-nextjs:latest

    volumes:
      - ..:/workspace:delegated
      - bashhistory:/commandhistory
      - claude-config:/home/node/.claude
      - ~/.claude/agents:/home/node/.claude/agents
      - ~/.claude/skills:/home/node/.claude/skills
      - ~/.claude/plugins:/home/node/.claude/plugins
      - backend-venv:/workspace/backend/.venv
      - frontend-node-modules:/workspace/frontend/node_modules

    cap_add:
      - NET_ADMIN
      - NET_RAW

    environment:
      NODE_OPTIONS: "--max-old-space-size=4096"
      CLAUDE_CONFIG_DIR: "/home/node/.claude"
      # Django settings
      DJANGO_SETTINGS_MODULE: "config.settings.local"
      DJANGO_DEBUG: "True"
      # Database connection
      DATABASE_URL: "postgres://postgres:postgres@postgres:5432/appdb"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "appdb"
      # Redis connection
      REDIS_URL: "redis://redis:6379/0"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      # Celery
      CELERY_BROKER_URL: "redis://redis:6379/0"

    command: sleep infinity

    depends_on:
      - postgres
      - redis

    networks:
      - app-network

  celery:
    image: ghcr.io/harmonytics/django-nextjs:latest
    profiles:
      - celery

    volumes:
      - ..:/workspace:delegated
      - backend-venv:/workspace/backend/.venv

    working_dir: /workspace/backend

    environment:
      DJANGO_SETTINGS_MODULE: "config.settings.local"
      DATABASE_URL: "postgres://postgres:postgres@postgres:5432/appdb"
      REDIS_URL: "redis://redis:6379/0"
      CELERY_BROKER_URL: "redis://redis:6379/0"

    command: >
      bash -c "
        echo 'Waiting for dependencies...' &&
        until [ -f /workspace/backend/.venv/bin/celery ]; do sleep 2; done &&
        cd /workspace/backend &&
        uv run celery -A config.celery_app worker -l info
      "

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - app-network

    restart: unless-stopped

  celerybeat:
    image: ghcr.io/harmonytics/django-nextjs:latest
    profiles:
      - celery

    volumes:
      - ..:/workspace:delegated
      - backend-venv:/workspace/backend/.venv

    working_dir: /workspace/backend

    environment:
      DJANGO_SETTINGS_MODULE: "config.settings.local"
      DATABASE_URL: "postgres://postgres:postgres@postgres:5432/appdb"
      REDIS_URL: "redis://redis:6379/0"
      CELERY_BROKER_URL: "redis://redis:6379/0"

    command: >
      bash -c "
        echo 'Waiting for dependencies...' &&
        until [ -f /workspace/backend/.venv/bin/celery ]; do sleep 2; done &&
        cd /workspace/backend &&
        uv run celery -A config.celery_app beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
      "

    depends_on:
      - celery

    networks:
      - app-network

    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg17
    restart: unless-stopped

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: appdb

    volumes:
      - postgres-data:/var/lib/postgresql/data

    networks:
      - app-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped

    command: redis-server --appendonly yes

    volumes:
      - redis-data:/data

    networks:
      - app-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
  redis-data:
  bashhistory:
  claude-config:
  backend-venv:
  frontend-node-modules:

networks:
  app-network:
    driver: bridge
